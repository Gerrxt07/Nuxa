name: âš¡ CI Pipeline

on:
  push:
    branches: [ "main", "master", "dev", "develop" ]
  pull_request:
    branches: [ "main", "master", "dev", "develop" ]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  eslint:
    name: ðŸ” ESLint
    uses: ./.github/workflows/eslint.yml
    permissions:
      contents: read
      pull-requests: write
      checks: write
  
  test:
    name: ðŸ§ª Test & Build
    runs-on: ubuntu-latest
    needs: eslint
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
      
      - name: ðŸ”§ Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
      
      - name: ðŸ“¦ Cache Dependencies
        uses: actions/cache@v4
        id: cache-deps
        with:
          path: |
            ~/.bun/install/cache
            node_modules
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lockb', '**/package.json') }}
          restore-keys: |
            ${{ runner.os }}-bun-
      
      - name: ðŸ“¥ Install Dependencies
        if: steps.cache-deps.outputs.cache-hit != 'true'
        run: bun install --frozen-lockfile
      
      - name: ðŸ§ª Run Tests
        id: test
        run: |
          if [ -f "package.json" ] && grep -q "\"test\"" package.json; then
            echo "Running tests..."
            bun run test || echo "test_failed=true" >> $GITHUB_OUTPUT
          else
            echo "No test script found, skipping..."
            echo "test_skipped=true" >> $GITHUB_OUTPUT
          fi
      
      - name: ðŸ—ï¸ Build Project
        id: build
        run: |
          if [ -f "package.json" ] && grep -q "\"build\"" package.json; then
            echo "Building project..."
            bun run build
          else
            echo "No build script found, skipping..."
            echo "build_skipped=true" >> $GITHUB_OUTPUT
          fi
      
      - name: ðŸ“¦ Cache Build Output
        if: steps.build.outputs.build_skipped != 'true'
        uses: actions/cache@v4
        with:
          path: |
            .nuxt
            .output
            dist
          key: ${{ runner.os }}-build-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-build-
      
      - name: ðŸ“¢ Summary
        if: always()
        run: |
          echo "## âš¡ CI Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "> ðŸ” ESLint runs in a separate job" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Test status
          if [ "${{ steps.test.outputs.test_skipped }}" == "true" ]; then
            echo "- ðŸ§ª **Testing**: â­ï¸ Skipped (no test script)" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.test.outputs.test_failed }}" == "true" ]; then
            echo "- ðŸ§ª **Testing**: âŒ Failed" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ðŸ§ª **Testing**: âœ… Passed" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Build status
          if [ "${{ steps.build.outputs.build_skipped }}" == "true" ]; then
            echo "- ðŸ—ï¸ **Build**: â­ï¸ Skipped (no build script)" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ðŸ—ï¸ **Build**: âœ… Completed" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“¦ **Cache Hit**: ${{ steps.cache-deps.outputs.cache-hit == 'true' && 'âœ… Yes' || 'âŒ No' }}" >> $GITHUB_STEP_SUMMARY

  type-check:
    name: ðŸ“ Type Check
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
      
      - name: ðŸ”§ Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
      
      - name: ðŸ“¦ Restore Cached Dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
            node_modules
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lockb', '**/package.json') }}
          restore-keys: |
            ${{ runner.os }}-bun-
      
      - name: ðŸ“¥ Install Dependencies
        run: bun install --frozen-lockfile
      
      - name: ðŸ“ Run Type Check
        run: |
          if [ -f "package.json" ] && grep -q "\"typecheck\"" package.json; then
            echo "Running type check..."
            bun run typecheck
          elif [ -f "tsconfig.json" ]; then
            echo "Running tsc..."
            bunx tsc --noEmit
          else
            echo "No TypeScript configuration found, skipping..."
          fi
      
      - name: ðŸ“¢ Summary
        if: always()
        run: |
          echo "## ðŸ“ Type Check Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Type checking completed successfully" >> $GITHUB_STEP_SUMMARY
